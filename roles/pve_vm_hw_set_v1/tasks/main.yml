# ---------- NEW: compute net dict for proxmox_kvm ----------
- name: Compute net dict (bridge)
  ansible.builtin.set_fact:
    _pve_net: >-
      {{
        {
          "net0": "virtio,bridge=" ~ (pve_bridge | default("vmbr0"))
        }
      }}
  changed_when: false


# ---------- APPLY ----------
- name: Tune VM config (CPU/RAM/agent/boot/scsihw/onboot)
  community.proxmox.proxmox_kvm:
    api_host: "{{ pve_api_host | default(hostvars[pve_node].ansible_host | default(pve_node)) }}"
    api_user: "{{ pve_api_user }}"
    api_token_id: "{{ pve_api_token_id }}"
    api_token_secret: "{{ pve_api_token_secret }}"
    validate_certs: "{{ pve_api_validate_certs | default(false) }}"
    node: "{{ pve_node }}"
    vmid: "{{ vmid }}"

    # CPU/RAM
    cores: "{{ pve_cores | int }}"
    sockets: "{{ pve_sockets | int }}"
    cpu: "{{ pve_cpu }}"
    memory: "{{ pve_memory | int }}"
    balloon: "{{ pve_balloon | int }}"

    # Platform
    scsihw: "{{ pve_scsihw }}"

    # Agent / boot
    agent: "{{ pve_agent | int }}"
    onboot: "{{ pve_onboot | int }}"
    boot: "order={{ pve_boot_order }}"


    # Misc
    hotplug: "{{ pve_hotplug }}"
    description: "{{ pve_description | default('') }}"
    tags: "{{ pve_tags | default('') }}"
  delegate_to: localhost

# --- Network bridge (net0)
- name: Set net0 bridge + MAC (qm) via raw
  ansible.builtin.raw: >-
    qm set {{ vmid | int }}
    --net0 virtio={{ vm_mac }},bridge={{ pve_bridge | default('vmbr0') }}
  when: _qm_cfg.stdout is not search('net0:.*virtio=' ~ (vm_mac | lower))
  delegate_to: "{{ pve_node }}"

- name: Pin dhclient client-id from MAC
  ansible.builtin.copy:
    dest: /etc/dhcp/dhclient.conf
    mode: "0644"
    content: |
      send dhcp-client-identifier {{ dhcpv4_client_id }};
  notify: restart networking

