# roles/canary_ssh/tasks/main.yml
- name: Canary - ping (Ansible transport ok)
  ansible.builtin.ping:

- name: Canary - sudo noninteractive works
  ansible.builtin.command: sudo -n true
  changed_when: false

- name: Canary - sshd config valid
  ansible.builtin.command: sshd -t
  changed_when: false

- name: Canary - sshd active
  ansible.builtin.command: systemctl is-active ssh
  changed_when: false

- name: Canary - real ssh auth test from control node
  delegate_to: localhost
  become: false
  changed_when: false
  ansible.builtin.command: >
    ssh -o BatchMode=yes -o ConnectTimeout=5
    -p {{ ansible_port | default(22) }}
    -i {{ ansible_ssh_private_key_file }}
    {{ ansible_user | default('ansible') }}@{{ ansible_host | default(inventory_hostname) }}
    "echo OK"
