---
- name: Gather facts when missing
  ansible.builtin.setup:
    gather_subset:
      - '!all'
      - 'min'
      - 'distribution'
  when: ansible_facts.os_family is not defined
  changed_when: false

# roles/root_to_normal/tasks/main.yml
- name: Preflight - users_manage must be defined and a list
  ansible.builtin.assert:
    that:
      - users_manage is defined
      - users_manage is iterable
      - users_manage | length > 0
    fail_msg: "users_manage missing/empty. Define group_vars/all/users.yml"
  tags: [preflight]

# Step 1 > update

- name: Ensure apt cache is up to date (Debian/Ubuntu)
  ansible.builtin.apt:
    update_cache: true
    cache_valid_time: 3600
  when: ansible_facts.os_family == "Debian"

- name: Upgrade packages (safe)
  ansible.builtin.apt:
    upgrade: "safe"
  when: ansible_facts.os_family == "Debian"

# Step 2 > sudo 

- name: Ensure sudo is installed (Debian/Proxmox)
  ansible.builtin.apt:
    name: sudo
    state: present
    update_cache: true
  when: ansible_facts.os_family == "Debian"
  become: true
  tags: [bootstrap]

# Step 3 > Users

- name: Ensure required groups exist
  ansible.builtin.group:
    name: "{{ item }}"
    state: present
  loop: "{{ (users_manage | map(attribute='groups') | list | flatten | unique) | default([]) }}"

- name: Read passwd database
  ansible.builtin.getent:
    database: passwd
  become: true

- name: Fail on UID collisions (except same user)
  ansible.builtin.assert:
    that:
      - item.uid is not defined
        or (getent_passwd | dict2items | selectattr('value.1','equalto', item.uid|string) | list | length == 0)
        or (getent_passwd | dict2items | selectattr('value.1','equalto', item.uid|string) | map(attribute='key') | first == item.name)
    fail_msg: "UID {{ item.uid }} is already used by another user in VM; fix users_manage/template."
  loop: "{{ users_manage }}"
  loop_control:
    label: "{{ item.name }}"
    
- name: Detect remote login user
  ansible.builtin.command: id -un
  register: _login_user
  changed_when: false

- name: Create/Update users (safe for current login)
  ansible.builtin.user:
    name: "{{ item.name }}"
    uid: "{{ (omit if item.name == _login_user.stdout else (item.uid | default(omit))) }}"
    shell: "{{ item.shell | default('/bin/bash') }}"
    groups: "{{ item.groups | default([]) }}"
    append: true
    create_home: "{{ item.create_home | default(true) }}"
    state: present
  loop: "{{ users_manage }}"
  become: true

- name: Configure passwordless sudo for selected users
  ansible.builtin.copy:
    dest: "/etc/sudoers.d/90-ansible-bootstrap"
    owner: root
    group: root
    mode: "0440"
    validate: "visudo -cf %s"
    content: |
      {% for u in users_manage | default([]) %}
      {% if (u.sudo_nopasswd | default(false)) | bool %}
      {{ u.name }} ALL=(ALL) NOPASSWD:ALL
      {% endif %}
      {% endfor %}

- name: Remove legacy per-user sudoers files (optional cleanup)
  ansible.builtin.file:
    path: "/etc/sudoers.d/{{ item.name }}"
    state: absent
  loop: "{{ users_manage | default([]) }}"
  when: item.sudo_nopasswd | default(false) | bool



