---
- name: Get Proxmox nodes via API
  ansible.builtin.uri:
    url: "https://{{ pve_api_host }}:8006/api2/json/nodes"
    method: GET
    validate_certs: "{{ pve_api_validate_certs }}"
    headers:
      Authorization: "PVEAPIToken={{ pve_api_user }}!{{ pve_api_token_id }}={{ pve_api_token_secret }}"
    return_content: true
  register: _nodes
  changed_when: false

- name: Show node names (debug)
  ansible.builtin.debug:
    msg: "{{ _nodes.json.data | map(attribute='node') | list }}"

- name: Derived vars
  ansible.builtin.set_fact:
    _pve_node: "{{ pve_target_node | default(pve_node_default) }}"
    _ciuser: "{{ pve_ciuser_default }}"
    _domain: "{{ vm_domain | default(pve_searchdomain_default) }}"
    _ipconfig0: "{{ vm_ipconfig0 | default(pve_ipconfig0_default) }}"
  changed_when: false

- name: Check if target VM exists (API)
  community.proxmox.proxmox_kvm:
    api_host: "{{ pve_api_host }}"
    api_user: "{{ pve_api_user }}"
    api_token_id: "{{ pve_api_token_id }}"
    api_token_secret: "{{ pve_api_token_secret }}"
    validate_certs: "{{ pve_api_validate_certs }}"
    node: "{{ _pve_node }}"
    vmid: "{{ vmid | int }}"
    state: current
  register: _current
  failed_when: false
  changed_when: false

- name: Clone via raw API (vmid -> newid)
  ansible.builtin.uri:
    url: "https://{{ pve_api_host }}:{{ pve_api_port }}/api2/json/nodes/{{ _pve_node }}/qemu/{{ pve_template_vmid | int }}/clone"
    method: POST
    validate_certs: "{{ pve_api_validate_certs }}"
    headers:
      Authorization: "PVEAPIToken={{ pve_api_user }}!{{ pve_api_token_id }}={{ pve_api_token_secret }}"
    body_format: form-urlencoded
    body:
      newid: "{{ vmid | int }}"
      name: "{{ vm_name }}"
      full: "{{ 1 if (pve_clone_full | bool) else 0 }}"
      target: "{{ _pve_node }}"
    status_code: [200]
  register: _clone_job
  when: "'does not exist' in (_current.msg | default('') | lower)"
  changed_when: true

- name: Wait for clone task to finish
  ansible.builtin.uri:
    url: "https://{{ pve_api_host }}:{{ pve_api_port }}/api2/json/nodes/{{ _pve_node }}/tasks/{{ _clone_job.json.data }}/status"
    method: GET
    validate_certs: "{{ pve_api_validate_certs }}"
    headers:
      Authorization: "PVEAPIToken={{ pve_api_user }}!{{ pve_api_token_id }}={{ pve_api_token_secret }}"
    return_content: true
  register: _task_status
  until: _task_status.json.data.status == "stopped"
  retries: 120
  delay: 2
  when: _clone_job is defined and _clone_job.json is defined
  changed_when: false

- name: Fail if clone task failed
  ansible.builtin.fail:
    msg: "Clone failed: {{ _task_status.json.data | to_nice_json }}"
  when: _clone_job is defined and _task_status.json.data.exitstatus is defined and _task_status.json.data.exitstatus != "OK"
  
- name: Re-check target VM exists after clone (API)
  community.proxmox.proxmox_kvm:
    api_host: "{{ pve_api_host }}"
    api_user: "{{ pve_api_user }}"
    api_token_id: "{{ pve_api_token_id }}"
    api_token_secret: "{{ pve_api_token_secret }}"
    validate_certs: "{{ pve_api_validate_certs }}"
    node: "{{ _pve_node }}"
    vmid: "{{ vmid | int }}"
    state: current
  register: _current2
  failed_when: false
  changed_when: false

- name: Fail if VM still does not exist (clone did not create config)
  ansible.builtin.fail:
    msg: "Clone did not create VM config for vmid={{ vmid }} on node={{ _pve_node }}. Check template vmid={{ pve_template_vmid }} exists and API permissions."
  when: "'does not exist' in (_current2.msg | default('') | lower)"

- name: Configure cloud-init (API) DHCP + searchdomain
  community.proxmox.proxmox_kvm:
    api_host: "{{ pve_api_host }}"
    api_user: "{{ pve_api_user }}"
    api_token_id: "{{ pve_api_token_id }}"
    api_token_secret: "{{ pve_api_token_secret }}"
    validate_certs: "{{ pve_api_validate_certs }}"
    node: "{{ _pve_node }}"
    vmid: "{{ vmid | int }}"
    update: true
    ciuser: "{{ _ciuser }}"
    ipconfig:
      ipconfig0: "{{ _ipconfig0 }}"          # "ip=dhcp"
    searchdomains:
      - "{{ _domain }}"                      # "local"
    state: present

# ZT NOTE:
# hostname/FQDN nastavíš neskôr cez cicustom snippet alebo bootstrap rolu v guest OS.
# sshkeys/certy sa tu nepchajú.

- name: Start VM (API)
  community.proxmox.proxmox_kvm:
    api_host: "{{ pve_api_host }}"
    api_user: "{{ pve_api_user }}"
    api_token_id: "{{ pve_api_token_id }}"
    api_token_secret: "{{ pve_api_token_secret }}"
    validate_certs: "{{ pve_api_validate_certs }}"
    node: "{{ _pve_node }}"
    vmid: "{{ vmid | int }}"
    state: started
