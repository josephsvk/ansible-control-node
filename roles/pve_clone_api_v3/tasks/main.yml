---
- name: Preflight checks
  ansible.builtin.import_tasks: preflight.yml
  tags: [preflight]

# ---- Role-local defaults (deterministic, no dependency on external var shape)
- name: Role defaults
  ansible.builtin.set_fact:
    _pve_node: "{{ pve_target_node | default(pve_node) }}"          # Proxmox compute node where VM lives
    _ciuser: "{{ pve_ciuser | default('ansible') }}"
    _domain: "{{ vm_domain | default(domain_name | default('local')) }}"
    _ipconfig0: "{{ vm_ipconfig0 | default('ip=dhcp') }}"
    _validate_certs: "{{ pve_api_validate_certs | default(false) }}" # do NOT read from hostvars[pve_node]
    _template_vmid: "{{ pve_template_vmid | default(clone_from_template_vmid) }}"
  changed_when: false

- name: Assert required vars exist
  ansible.builtin.assert:
    that:
      - _pve_api_host is defined
      - _pve_api_port is defined
      - _pve_api_user is defined
      - _pve_api_token_id is defined
      - _pve_api_token_secret is defined
      - vmid is defined
      - vm_name is defined
      - _template_vmid is defined
      - _pve_node is defined
      - ssh_pub_key_path_local is defined
    fail_msg: >-
      Missing required vars on '{{ inventory_hostname }}'.
      Need: _pve_api_host/_pve_api_port/_pve_api_user/_pve_api_token_id/_pve_api_token_secret,
      vmid, vm_name, clone_from_template_vmid (or pve_template_vmid), pve_node (or pve_target_node),
      ssh_pub_key_path_local.
  changed_when: false

# ---- Optional debug: nodes info (safe)
- name: Get Proxmox nodes via API (info)
  community.proxmox.proxmox_node_info:
    api_host: "{{ _pve_api_host }}"
    api_port: "{{ _pve_api_port }}"
    api_user: "{{ _pve_api_user }}"
    api_token_id: "{{ _pve_api_token_id }}"
    api_token_secret: "{{ _pve_api_token_secret }}"
    validate_certs: "{{ _validate_certs }}"
  delegate_to: localhost
  register: pve_nodes_info
  changed_when: false

# ---- Check VM existence (robustly)
- name: Get VM config via raw API (exists check)
  ansible.builtin.uri:
    url: "https://{{ _pve_api_host }}:{{ _pve_api_port }}/api2/json/nodes/{{ _pve_node }}/qemu/{{ vmid | int }}/config"
    method: GET
    validate_certs: "{{ _validate_certs }}"
    headers:
      Authorization: "PVEAPIToken={{ _pve_api_user }}!{{ _pve_api_token_id }}={{ _pve_api_token_secret }}"
    return_content: true
    status_code: [200, 500]
  delegate_to: localhost
  register: _vm_cfg_check
  changed_when: false

- name: Set VM exists fact
  ansible.builtin.set_fact:
    _vm_exists: "{{ _vm_cfg_check.status == 200 }}"
  changed_when: false

# ---- Clone only if VM does not exist
- name: Clone via raw API (template vmid -> newid)
  ansible.builtin.uri:
    url: "https://{{ _pve_api_host }}:{{ _pve_api_port }}/api2/json/nodes/{{ _pve_node }}/qemu/{{ _template_vmid | int }}/clone"
    method: POST
    validate_certs: "{{ _validate_certs }}"
    headers:
      Authorization: "PVEAPIToken={{ _pve_api_user }}!{{ _pve_api_token_id }}={{ _pve_api_token_secret }}"
    body_format: form-urlencoded
    body:
      newid: "{{ vmid | int }}"
      name: "{{ vm_name }}"
      full: "{{ 1 if (pve_clone_full | default(true) | bool) else 0 }}"
      target: "{{ _pve_node }}"
    status_code: [200]
  delegate_to: localhost
  register: _clone_job
  when: not _vm_exists
  changed_when: true

- name: Wait for clone task to finish
  ansible.builtin.uri:
    url: "https://{{ _pve_api_host }}:{{ _pve_api_port }}/api2/json/nodes/{{ _pve_node }}/tasks/{{ _clone_job.json.data }}/status"
    method: GET
    validate_certs: "{{ _validate_certs }}"
    headers:
      Authorization: "PVEAPIToken={{ _pve_api_user }}!{{ _pve_api_token_id }}={{ _pve_api_token_secret }}"
    return_content: true
  delegate_to: localhost
  register: _task_status
  until: _task_status.json.data.status == "stopped"
  retries: 180
  delay: 2
  when: _clone_job is defined and _clone_job.json is defined and _clone_job.json.data is defined
  changed_when: false

- name: Fail if clone task failed
  ansible.builtin.fail:
    msg: "Clone failed: {{ _task_status.json.data | to_nice_json }}"
  when: >
    _clone_job is defined and
    _task_status is defined and
    _task_status.json is defined and
    _task_status.json.data is defined and
    (_task_status.json.data.exitstatus | default('OK')) != 'OK'

# ---- Ensure VM exists after clone
- name: Re-check VM config exists after clone
  ansible.builtin.uri:
    url: "https://{{ _pve_api_host }}:{{ _pve_api_port }}/api2/json/nodes/{{ _pve_node }}/qemu/{{ vmid | int }}/config"
    method: GET
    validate_certs: "{{ _validate_certs }}"
    headers:
      Authorization: "PVEAPIToken={{ _pve_api_user }}!{{ _pve_api_token_id }}={{ _pve_api_token_secret }}"
    status_code: [200]
  delegate_to: localhost
  register: _vm_cfg_after
  when: not _vm_exists
  changed_when: false

# ---- SSH key for cloud-init
- name: Read public key content (control node)
  ansible.builtin.slurp:
    src: "{{ ssh_pub_key_path_local }}"
  delegate_to: localhost
  become: false
  register: _pub

- name: Set ssh pubkey fact
  ansible.builtin.set_fact:
    _ssh_pubkey: "{{ (_pub.content | b64decode).strip() }}"
  changed_when: false

# ---- Cloud-init config (single source of truth) + deterministic lifecycle
- name: Configure cloud-init (API) DHCP + searchdomain + ssh key
  community.proxmox.proxmox_kvm:
    api_host: "{{ _pve_api_host }}"
    api_port: "{{ _pve_api_port }}"
    api_user: "{{ _pve_api_user }}"
    api_token_id: "{{ _pve_api_token_id }}"
    api_token_secret: "{{ _pve_api_token_secret }}"
    validate_certs: "{{ _validate_certs }}"
    node: "{{ _pve_node }}"
    vmid: "{{ vmid | int }}"
    update: true
    ciuser: "{{ _ciuser }}"
    ipconfig:
      ipconfig0: "{{ _ipconfig0 }}"
    searchdomains:
      - "{{ _domain }}"
    sshkeys: "{{ _ssh_pubkey }}"
  delegate_to: localhost

- name: Read VM runtime status
  ansible.builtin.uri:
    url: "https://{{ _pve_api_host }}:{{ _pve_api_port }}/api2/json/nodes/{{ _pve_node }}/qemu/{{ vmid | int }}/status/current"
    method: GET
    validate_certs: "{{ _validate_certs }}"
    headers:
      Authorization: "PVEAPIToken={{ _pve_api_user }}!{{ _pve_api_token_id }}={{ _pve_api_token_secret }}"
    return_content: true
  delegate_to: localhost
  register: _vm_status
  changed_when: false

- name: Start VM (if stopped)
  ansible.builtin.uri:
    url: "https://{{ _pve_api_host }}:{{ _pve_api_port }}/api2/json/nodes/{{ _pve_node }}/qemu/{{ vmid | int }}/status/start"
    method: POST
    validate_certs: "{{ _validate_certs }}"
    headers:
      Authorization: "PVEAPIToken={{ _pve_api_user }}!{{ _pve_api_token_id }}={{ _pve_api_token_secret }}"
    status_code: [200]
  delegate_to: localhost
  when: _vm_status.json.data.status != "running"

- name: Reboot VM (if running)
  ansible.builtin.uri:
    url: "https://{{ _pve_api_host }}:{{ _pve_api_port }}/api2/json/nodes/{{ _pve_node }}/qemu/{{ vmid | int }}/status/reboot"
    method: POST
    validate_certs: "{{ _validate_certs }}"
    headers:
      Authorization: "PVEAPIToken={{ _pve_api_user }}!{{ _pve_api_token_id }}={{ _pve_api_token_secret }}"
    status_code: [200]
  delegate_to: localhost
  when: _vm_status.json.data.status == "running"

- name: Read current VM config (debug)
  ansible.builtin.uri:
    url: "https://{{ _pve_api_host }}:{{ _pve_api_port }}/api2/json/nodes/{{ _pve_node }}/qemu/{{ vmid | int }}/config"
    method: GET
    validate_certs: "{{ _validate_certs }}"
    headers:
      Authorization: "PVEAPIToken={{ _pve_api_user }}!{{ _pve_api_token_id }}={{ _pve_api_token_secret }}"
    return_content: true
    status_code: [200]
  delegate_to: localhost
  register: _cfg
  changed_when: false

- ansible.builtin.debug:
    msg:
      - "ciuser={{ _cfg.json.data.ciuser | default('') }}"
      - "searchdomain={{ _cfg.json.data.searchdomain | default('') }}"
      - "ipconfig0={{ _cfg.json.data.ipconfig0 | default('') }}"
  changed_when: false
