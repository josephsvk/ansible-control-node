---
- name: Validate vars (clone)
  ansible.builtin.assert:
    that:
      - pve_api_host is defined
      - pve_api_user is defined
      - pve_api_token_id is defined
      - pve_api_token_secret is defined
      - haos_template_vmid is defined
      - vmid is defined
      - vm_name is defined

- name: Derived vars
  ansible.builtin.set_fact:
    _pve_node: "{{ pve_target_node | default(pve_node_name) }}"
  changed_when: false

- name: Check if target VM exists (API)
  community.proxmox.proxmox_kvm:
    api_host: "{{ pve_api_host }}"
    api_user: "{{ pve_api_user }}"
    api_token_id: "{{ pve_api_token_id }}"
    api_token_secret: "{{ pve_api_token_secret }}"
    validate_certs: "{{ pve_api_validate_certs }}"
    node: "{{ _pve_node }}"
    vmid: "{{ vmid | int }}"
    state: current
  register: _current
  failed_when: false
  changed_when: false

- name: Clone via API (template -> vm)
  ansible.builtin.uri:
    url: "https://{{ pve_api_host }}:{{ pve_api_port }}/api2/json/nodes/{{ _pve_node }}/qemu/{{ haos_template_vmid | int }}/clone"
    method: POST
    validate_certs: "{{ pve_api_validate_certs }}"
    headers:
      Authorization: "PVEAPIToken={{ pve_api_user }}!{{ pve_api_token_id }}={{ pve_api_token_secret }}"
    body_format: form-urlencoded
    body:
      newid: "{{ vmid | int }}"
      name: "{{ vm_name }}"
      full: 1
      target: "{{ _pve_node }}"
    status_code: [200]
  register: _clone_job
  when: "'does not exist' in (_current.msg | default('') | lower)"
  changed_when: true

- name: Wait for clone task to finish
  ansible.builtin.uri:
    url: "https://{{ pve_api_host }}:{{ pve_api_port }}/api2/json/nodes/{{ _pve_node }}/tasks/{{ _clone_job.json.data }}/status"
    method: GET
    validate_certs: "{{ pve_api_validate_certs }}"
    headers:
      Authorization: "PVEAPIToken={{ pve_api_user }}!{{ pve_api_token_id }}={{ pve_api_token_secret }}"
    return_content: true
  register: _task_status
  until: _task_status.json.data.status == "stopped"
  retries: 120
  delay: 2
  when: _clone_job is defined and _clone_job.json is defined
  changed_when: false

- name: Fail if clone task failed
  ansible.builtin.fail:
    msg: "Clone failed: {{ _task_status.json.data | to_nice_json }}"
  when: _clone_job is defined and _task_status.json.data.exitstatus is defined and _task_status.json.data.exitstatus != "OK"

- name: Apply onboot/protection (API update)
  community.proxmox.proxmox_kvm:
    api_host: "{{ pve_api_host }}"
    api_user: "{{ pve_api_user }}"
    api_token_id: "{{ pve_api_token_id }}"
    api_token_secret: "{{ pve_api_token_secret }}"
    validate_certs: "{{ pve_api_validate_certs }}"
    node: "{{ _pve_node }}"
    vmid: "{{ vmid | int }}"
    update: true
    onboot: "{{ pve_onboot | default(true) | bool }}"
    protection: "{{ pve_protection | default(true) | bool }}"
    state: present
  changed_when: true

- name: Start VM
  community.proxmox.proxmox_kvm:
    api_host: "{{ pve_api_host }}"
    api_user: "{{ pve_api_user }}"
    api_token_id: "{{ pve_api_token_id }}"
    api_token_secret: "{{ pve_api_token_secret }}"
    validate_certs: "{{ pve_api_validate_certs }}"
    node: "{{ _pve_node }}"
    vmid: "{{ vmid | int }}"
    state: started
    timeout: 300
