---

- name: Ensure local ~/.ssh exists (control node)
  ansible.builtin.file:
    path: "{{ ssh_key_dir }}"
    state: directory
    mode: "0700"
  delegate_to: localhost
  run_once: false

- name: Generate ed25519 keypair on control node if missing
  community.crypto.openssh_keypair:
    path: "{{ ssh_key_dir }}/{{ inventory_hostname }}_ed25519"
    type: ed25519
    comment: "{{ inventory_hostname }}"
    mode: "0600"
  delegate_to: localhost
  register: _keypair

- name: Gather facts (for ansible_user_id)
  ansible.builtin.setup:

- name: Install public key into target user's authorized_keys
  ansible.posix.authorized_key:
    user: "{{ ansible_user_id | default('root') }}"
    key: "{{ _keypair.public_key }}"
    state: present
    manage_dir: true
  become: true




