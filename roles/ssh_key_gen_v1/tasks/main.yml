- import_tasks: preflight.yml

- name: Ensure local ssh directories exist
  delegate_to: localhost
  become: false
  file:
    path: "{{ item }}"
    state: directory
    mode: "0700"
  loop:
    - "{{ ssh_key_dir_local }}"
    - "{{ ssh_config_dir_local }}"

- name: Generate keypair for ansible user on control node (per host)
  delegate_to: localhost
  become: false
  community.crypto.openssh_keypair:
    path: "{{ ssh_key_path_local }}"
    type: ed25519
    comment: "{{ vm_name | default(inventory_hostname) }}:ansible"
    mode: "0600"
  register: _ansible_key


- name: Write per-host SSH config snippet (control node)
  delegate_to: localhost
  become: false
  copy:
    dest: "{{ ssh_config_dir_local }}/{{ vm_name | default(inventory_hostname) }}.conf"
    mode: "0600"
    content: |
      Host {{ vm_name | default(inventory_hostname) }}
        User {{ ssh_remote_user }}
        Port {{ ssh_remote_port }}
        IdentityFile {{ ssh_key_path_local }}
        IdentitiesOnly yes
        PreferredAuthentications publickey
        ServerAliveInterval 30
        ServerAliveCountMax 3
