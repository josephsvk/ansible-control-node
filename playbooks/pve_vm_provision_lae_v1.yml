---
- name: Provision VM(s) from template using lae.proxmox
  hosts: pve_vms
  gather_facts: false

  tasks:
    - name: Map inventory vars to lae.proxmox expected vars
      ansible.builtin.set_fact:
        proxmox_node: "{{ pve_target_node }}"
        proxmox_vm:
          vmid: "{{ vmid }}"
          name: "{{ vm_name }}"
          node: "{{ pve_target_node }}"
          clone: "{{ pve_template_vmid }}"
          newid: "{{ vmid }}"
          full: "{{ pve_clone_full | default(false) | bool }}"
          # cloud-init via API module naming (supported in proxmox_kvm)
          ciuser: "{{ pve_ciuser_default }}"
          ipconfig:
            ipconfig0: "{{ pve_ipconfig0_default }}"
          searchdomains:
            - "{{ vm_domain | default(pve_searchdomain_default) }}"
          net:
            net0: "virtio,bridge={{ pve_bridge_default }}"
      changed_when: false

    # lae.proxmox role používa community.proxmox.proxmox_kvm pod kapotou.
    # Použijeme ho priamo cez include_role, ale s našimi vars vyššie.
    - name: Clone + configure + start via lae.proxmox
      ansible.builtin.include_role:
        name: lae.proxmox
      vars:
        proxmox_api_host: "{{ proxmox_api_host }}"
        proxmox_api_user: "{{ proxmox_api_user }}"
        proxmox_api_token_id: "{{ proxmox_api_token_id }}"
        proxmox_api_token_secret: "{{ proxmox_api_token_secret }}"
        proxmox_validate_certs: "{{ proxmox_validate_certs }}"
        # ZT NOTE: hostname/FQDN rieš neskôr cez cicustom alebo bootstrap rolu v OS (module nemá hostname param)
