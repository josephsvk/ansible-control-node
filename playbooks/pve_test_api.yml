- name: Test Proxmox API token (vars from pve group, execution on localhost)
  hosts: pve
  gather_facts: false
  tasks:
    - name: Query node info via API (no node param)
      delegate_to: localhost
      run_once: true
      community.proxmox.proxmox_node_info:
        api_host: "{{ pve_api_host }}"
        api_user: "{{ pve_api_user }}"
        api_token_id: "{{ pve_api_token_id }}"
        api_token_secret: "{{ pve_api_token_secret }}"
        validate_certs: false
      register: nodeinfo

    - name: Show raw keys
      delegate_to: localhost
      run_once: true
      ansible.builtin.debug:
        var: nodeinfo

    - name: Show node names if present
      delegate_to: localhost
      run_once: true
      ansible.builtin.debug:
        msg:
          nodes: >-
            {{
              (nodeinfo.proxmox_nodes | default([]))
              | map(attribute='node')
              | list
            }}
