---
- name: Provision VM from golden template (qm clone + cloud-init)
  hosts: pve_vms
  gather_facts: false


  tasks:
    - name: Assert required VM vars
      ansible.builtin.assert:
        that:
          - vmid is defined
          - vm_name is defined
          - vm_domain is defined
          - pve_target_node is defined
          - pve_template_vmid is defined
      delegate_to: "{{ pve_target_node }}"

    - name: Clone from template (full clone)
      ansible.builtin.command: >
        qm clone {{ pve_template_vmid }} {{ vmid }}
        --name {{ vm_name }}
        --full 1
      delegate_to: "{{ pve_target_node }}"

    - name: Apply cloud-init identity + DHCP + net0
      ansible.builtin.shell: |
        set -euo pipefail
        qm set {{ vmid }} \
          --ciuser ansible \
          --ipconfig0 ip=dhcp \
          --hostname {{ vm_name }} \
          --searchdomain {{ vm_domain }}
      args:
        executable: /bin/bash
      delegate_to: "{{ pve_target_node }}"

    # ZT NOTE: neskôr sem pridáš:
    # - --nameserver <DNS>
    # - --sshkeys per-VM (short-lived / CA-signed)
    # - cert bootstrap (mTLS)

    - name: Start VM
      ansible.builtin.command: "qm start {{ vmid }}"
      delegate_to: "{{ pve_target_node }}"
