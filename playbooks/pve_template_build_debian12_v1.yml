---
- name: Phase 0 - Build cloud-init template on Proxmox node
  hosts: pve
  remote_user: ansible
  gather_facts: true
  become: true

  vars:
    img_dir: "/var/lib/vz/template/iso"
    img_path: "{{ img_dir }}/{{ cloudimg_filename }}"
    disk_volume: "{{ tmpl_storage }}:vm-{{ tmpl_vmid }}-disk-0"

  tasks:
    - name: Install required tooling on Proxmox
      ansible.builtin.apt:
        name:
          - libguestfs-tools
          - python3-requests
          - python3-urllib3
          - ca-certificates
        state: present
        update_cache: true

    - name: Ensure image directory exists
      ansible.builtin.file:
        path: "{{ img_dir }}"
        state: directory
        mode: "0755"
    
    - name: Sanity - Proxmox node must be x86_64
      ansible.builtin.assert:
        that:
          - ansible_facts.architecture in ['x86_64', 'amd64']
        fail_msg: "This playbook expects x86_64 Proxmox. Got: {{ ansible_facts.architecture }}"

    - name: Sanity - cloud image must be amd64
      ansible.builtin.assert:
        that:
          - "'amd64' in cloudimg_url"
          - "'amd64' in cloudimg_filename"
        fail_msg: "cloudimg_url/filename must be amd64. url={{ cloudimg_url }}, file={{ cloudimg_filename }}"


    - name: Download cloud image with wget (idempotent)
      ansible.builtin.command: >
        wget -O {{ img_path }} {{ cloudimg_url }}
      args:
        creates: "{{ img_path }}"

    - name: Sanity - show downloaded image file info
      ansible.builtin.command: "file {{ img_path }}"
      register: _file_info
      changed_when: false

    - name: Sanity - show image size
      ansible.builtin.command: "stat -c '%n %s bytes' {{ img_path }}"
      register: _stat_info
      changed_when: false

    - name: Sanity - print sanity results
      ansible.builtin.debug:
        msg:
          - "{{ _file_info.stdout }}"
          - "{{ _stat_info.stdout }}"
    
    - name: Sanity - downloaded image must be QCOW2
      ansible.builtin.assert:
        that:
          - "'QCOW' in _file_info.stdout or 'QEMU' in _file_info.stdout"
        fail_msg: "Downloaded file does not look like qcow2: {{ _file_info.stdout }}"
        
    - name: Customize image offline (packages + agent + cleanup)
      ansible.builtin.command: >
        virt-customize -a {{ img_path }}
        --install {{ tmpl_packages | join(',') }}
        --run-command "systemctl enable qemu-guest-agent"
        --run-command "truncate -s 0 /etc/machine-id"
        --run-command "cloud-init clean --logs"
      args:
        creates: "{{ img_path }}.customized"
      register: customize
      changed_when: customize.rc == 0

    - name: Mark image as customized
      ansible.builtin.file:
        path: "{{ img_path }}.customized"
        state: touch
      when: customize is changed

    - name: Create VM shell if missing
      ansible.builtin.command: >
        qm create {{ tmpl_vmid }}
        --name {{ tmpl_name }}
        --memory {{ tmpl_memory }}
        --cores {{ tmpl_cores }}
        --net0 virtio,bridge={{ tmpl_bridge }}
      args:
        creates: "/etc/pve/qemu-server/{{ tmpl_vmid }}.conf"

    - name: Import disk into storage (only once)
      ansible.builtin.command: >
        qm importdisk {{ tmpl_vmid }} {{ img_path }} {{ tmpl_storage }}
      args:
        creates: "/var/lib/vz/images/{{ tmpl_vmid }}/vm-{{ tmpl_vmid }}-disk-0.raw"
      register: importdisk
      changed_when: importdisk.rc == 0

    - name: Attach disk + cloud-init drive + boot order + agent
      ansible.builtin.command: >
        qm set {{ tmpl_vmid }}
        --scsihw virtio-scsi-pci
        --scsi0 {{ disk_volume }}
        --ide2 {{ tmpl_storage }}:cloudinit
        --boot c
        --bootdisk scsi0
        --serial0 socket
        --vga serial0
        --agent enabled=1
      register: qmset
      changed_when: qmset.rc == 0

    - name: Convert VM to template
      ansible.builtin.command: >
        qm template {{ tmpl_vmid }}
      register: qmtpl
      changed_when: qmtpl.rc == 0
